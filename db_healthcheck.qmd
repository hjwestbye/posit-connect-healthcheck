---
title: "DB Healthcheck (Postgres)"
format: html
execute:
  echo: false
  warning: false
  message: false
---



```{r}
# Packages
library(DBI)
library(RPostgres)

db_url <- "postgresql://postgres:slippmeginn@db.wtkzwwhvwdtsusourfjh.supabase.co:5432/postgres"
if (db_url == "") stop("FINANCE_DB_URL is not set")

`%||%` <- function(x, y) if (is.null(x) || identical(x, "")) y else x

parts <- DBI::dbParseURI(db_url)

q <- parts$query %||% list()
sslmode <- q$sslmode %||% "require"

con <- DBI::dbConnect(
  RPostgres::Postgres(),
  dbname   = parts$dbname,
  host     = parts$host,
  port     = parts$port %||% 5432,
  user     = parts$user,
  password = parts$password,
  sslmode  = sslmode
)

on.exit(try(DBI::dbDisconnect(con), silent = TRUE), add = TRUE)


# Insert a row
DBI::dbExecute(con, "
  INSERT INTO core.runs_healthcheck (who, note)
  VALUES ($1, $2);
", params = list("connect_cloud", "db_healthcheck.qmd"))

# Read last 5 rows
rows <- DBI::dbGetQuery(con, "
  SELECT id, ts_utc, who, note
  FROM core.runs_healthcheck
  ORDER BY id DESC
  LIMIT 5;
")

cat("Connected and wrote a row successfully.\n\n")
print(rows)

```


