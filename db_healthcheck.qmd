---
title: "DB Healthcheck (Postgres)"
format: html
execute:
  echo: false
  warning: false
  message: false
---



```{r}
# ---- helpers ----
need_env <- function(name) {
  v <- Sys.getenv(name, unset = "")
  if (!nzchar(v)) stop(sprintf("Missing env var: %s", name))
  v
}

need_cfg <- function(x, path) {
  if (is.null(x) || !nzchar(as.character(x))) stop(sprintf("Missing config value: %s", path))
  x
}

# ---- packages ----
library(DBI)
library(RPostgres)
library(yaml)

# ---- load config.yml (non-secret) ----
if (!file.exists("config.yml")) {
  stop("Missing config.yml in repo root. Create it and republish.")
}

cfg <- yaml::read_yaml("config.yml")

pg <- cfg$pg
host <- need_cfg(pg$host, "pg.host")
port <- as.integer(pg$port %||% 5432)
db   <- need_cfg(pg$dbname, "pg.dbname")
usr  <- need_cfg(pg$user, "pg.user")
ssl  <- pg$sslmode %||% "require"

# Password comes from env var (secret)
pwd <- "slippmeginn"

# minimal %||% helper
`%||%` <- function(x, y) if (is.null(x) || identical(x, "")) y else x

cat("Attempting Postgres connection:\n")
cat(sprintf("  host: %s\n  port: %s\n  db:   %s\n  user: %s\n  ssl:  %s\n\n",
            host, port, db, usr, ssl))

# ---- connect ----
con <- DBI::dbConnect(
  RPostgres::Postgres(),
  host     = host,
  port     = port,
  dbname   = db,
  user     = usr,
  password = pwd,
  sslmode  = ssl
)
on.exit(try(DBI::dbDisconnect(con), silent = TRUE), add = TRUE)

cat("Connected OK.\n\n")

# ---- init schema/table (idempotent) ----
DBI::dbExecute(con, "CREATE SCHEMA IF NOT EXISTS core;")

DBI::dbExecute(con, "
  CREATE TABLE IF NOT EXISTS core.runs_healthcheck (
    id BIGSERIAL PRIMARY KEY,
    ts_utc TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    who TEXT NOT NULL,
    note TEXT
  );
")

# ---- write a row ----
DBI::dbExecute(
  con,
  "INSERT INTO core.runs_healthcheck (who, note) VALUES ($1, $2);",
  params = list("connect_cloud", "db_healthcheck.qmd")
)

# ---- read back ----
rows <- DBI::dbGetQuery(con, "
  SELECT id, ts_utc, who, note
  FROM core.runs_healthcheck
  ORDER BY id DESC
  LIMIT 5;
")

cat("Wrote a row. Latest rows:\n\n")
print(rows)

```


