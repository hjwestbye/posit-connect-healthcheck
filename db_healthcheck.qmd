---
title: "DB Healthcheck (Postgres)"
format: html
execute:
  echo: false
  warning: false
  message: false
---



```{r}
# Packages
library(DBI)
library(RPostgres)

db_url <- "postgresql://postgres:slippmeginn@db.wtkzwwhvwdtsusourfjh.supabase.co:5432/postgres"
if (db_url == "") stop("FINANCE_DB_URL is not set")

# Minimal postgres URL parser:
# postgres://user:pass@host:5432/dbname?sslmode=require
parse_pg_url <- function(url) {
  # split query string
  parts <- strsplit(url, "\\?", fixed = FALSE)[[1]]
  base <- parts[1]
  query <- if (length(parts) > 1) parts[2] else ""

  # remove scheme
  base <- sub("^postgresql?://", "", base)

  # userinfo + host/db
  at_split <- strsplit(base, "@", fixed = TRUE)[[1]]
  if (length(at_split) != 2) stop("FINANCE_DB_URL must include userinfo@host, e.g. postgres://user:pass@host:5432/db")

  userinfo <- at_split[1]
  hostpart <- at_split[2]

  # user:pass
  up <- strsplit(userinfo, ":", fixed = TRUE)[[1]]
  user <- up[1]
  password <- if (length(up) >= 2) up[2] else ""

  # host:port/dbname
  hp_db <- strsplit(hostpart, "/", fixed = TRUE)[[1]]
  if (length(hp_db) < 2) stop("FINANCE_DB_URL must include /dbname")
  hostport <- hp_db[1]
  dbname <- hp_db[2]

  hp <- strsplit(hostport, ":", fixed = TRUE)[[1]]
  host <- hp[1]
  port <- if (length(hp) >= 2 && nzchar(hp[2])) as.integer(hp[2]) else 5432

  # query params (only sslmode needed for now)
  sslmode <- "require"
  if (nzchar(query)) {
    kvs <- strsplit(query, "&", fixed = TRUE)[[1]]
    for (kv in kvs) {
      kvp <- strsplit(kv, "=", fixed = TRUE)[[1]]
      if (length(kvp) == 2 && kvp[1] == "sslmode") sslmode <- kvp[2]
    }
  }

  list(host = host, port = port, dbname = dbname, user = user, password = password, sslmode = sslmode)
}

p <- parse_pg_url(db_url)

con <- DBI::dbConnect(
  RPostgres::Postgres(),
  dbname   = parts$dbname,
  host     = parts$host,
  port     = parts$port %||% 5432,
  user     = parts$user,
  password = parts$password,
  sslmode  = sslmode
)

on.exit(try(DBI::dbDisconnect(con), silent = TRUE), add = TRUE)


# Insert a row
DBI::dbExecute(con, "
  INSERT INTO core.runs_healthcheck (who, note)
  VALUES ($1, $2);
", params = list("connect_cloud", "db_healthcheck.qmd"))

# Read last 5 rows
rows <- DBI::dbGetQuery(con, "
  SELECT id, ts_utc, who, note
  FROM core.runs_healthcheck
  ORDER BY id DESC
  LIMIT 5;
")

cat("Connected and wrote a row successfully.\n\n")
print(rows)

```


