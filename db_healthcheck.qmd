---
title: "DB Healthcheck (Postgres)"
format: html
execute:
  echo: false
  warning: false
  message: false
---



```{r}
library(DBI)
library(RPostgres)

need_env <- function(name) {
  v <- Sys.getenv(name, unset = "")
  if (!nzchar(v)) stop(sprintf("Missing env var: %s", name))
  v
}

env_int <- function(name, default) {
  v <- Sys.getenv(name, unset = "")
  if (!nzchar(v)) return(default)
  suppressWarnings(as.integer(v))
}

env_str <- function(name, default) {
  v <- Sys.getenv(name, unset = "")
  if (!nzchar(v)) return(default)
  v
}

safe_exec <- function(con, sql, params = NULL) {
  tryCatch({
    if (is.null(params)) DBI::dbExecute(con, sql) else DBI::dbExecute(con, sql, params = params)
  }, error = function(e) {
    stop(paste0("DB error for SQL:\n", sql, "\n\n", conditionMessage(e)))
  })
}

safe_query <- function(con, sql) {
  tryCatch({
    DBI::dbGetQuery(con, sql)
  }, error = function(e) {
    stop(paste0("DB error for query:\n", sql, "\n\n", conditionMessage(e)))
  })
}

host <- need_env("PGHOST")
port <- env_int("PGPORT", 5432)
db   <- need_env("PGDATABASE")
usr  <- need_env("PGUSER")
pwd  <- "slippmeginn"
ssl  <- env_str("PGSSLMODE", "require")

cat("Attempting Postgres connection:\n")
cat(sprintf("  host: %s\n  port: %s\n  db:   %s\n  user: %s\n  ssl:  %s\n\n", host, port, db, usr, ssl))

con <- DBI::dbConnect(
  RPostgres::Postgres(),
  host     = host,
  port     = port,
  dbname   = db,
  user     = usr,
  password = pwd,
  sslmode  = ssl
)
on.exit(try(DBI::dbDisconnect(con), silent = TRUE), add = TRUE)

cat("Connected OK.\n\n")

# Quick sanity query (forces a roundtrip)
print(safe_query(con, "SELECT 1 AS ok;"))
cat("\n")

# DDL + write/read
safe_exec(con, "CREATE SCHEMA IF NOT EXISTS core;")

safe_exec(con, "
  CREATE TABLE IF NOT EXISTS core.runs_healthcheck (
    id BIGSERIAL PRIMARY KEY,
    ts_utc TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    who TEXT NOT NULL,
    note TEXT
  );
")

safe_exec(
  con,
  "INSERT INTO core.runs_healthcheck (who, note) VALUES ($1, $2);",
  params = list("connect_cloud", "db_healthcheck.qmd")
)

rows <- safe_query(con, "
  SELECT id, ts_utc, who, note
  FROM core.runs_healthcheck
  ORDER BY id DESC
  LIMIT 5;
")

cat("Wrote a row. Latest rows:\n\n")
print(rows)


```


